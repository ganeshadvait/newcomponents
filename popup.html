<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .gut-popup-input-group {
        position: relative;
      }

      .gut-popup-input,
      .gut-popup-number-input {
        border: solid 1.5px #90bcd2;
        border-radius: 9rem !important;
        background: none;
        padding: 1rem;
        font-size: 1rem;
        color: #f5f5f5;
        transition: border 150ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .gut-popup-label {
        position: absolute;
        left: 15px;
        top: -10%;
        /*color: #e8e8e8;*/
        pointer-events: none;
        transform: translateY(1rem);
        transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .gut-popup-input:focus,
      .gut-popup-input:valid,
      .gut-popup-number-input:focus,
      .gut-popup-number-input:valid {
        outline: none;
        border: 1.5px solid #000000;
        color: #000;
      }

      .gut-popup-input:focus ~ .gut-popup-label,
      .gut-popup-input:valid ~ .gut-popup-label,
      .gut-popup-number-input:focus ~ .gut-popup-label,
      .gut-popup-number-input:valid ~ .gut-popup-label {
        transform: translateY(-50%) scale(0.8);
        background-color: #fff;
        padding: 0 0.2em;
        color: #000;
      }

      .gut-popup-submit {
        border-radius: 9rem;
        padding: 1rem;
        width: 100%;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        background: #90bcd2;
      }

      .gut-popup-form {
        cursor: pointer;
      }

      .gut-popup-form div:nth-child(1),
      .gut-popup-form div:nth-child(2) {
        margin-bottom: 10px;
      }

      .gut-popup-success {
        display: none;
      }

      .gut-popup-error {
        display: none;
      }

      .gut-popup-invalid-phone {
        display: none;
        color: red;
      }
      .spinner {
        border: 2px solid #fff;
        border-top: 2px solid #000;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.6s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <section class="gut-popup-form">
      <div class="gut-popup-input-group">
        <input
          required
          type="text"
          name="text"
          autocomplete="off"
          class="gut-popup-input"
        />
        <label class="gut-popup-label">Name</label>
      </div>

      <div class="gut-popup-input-group">
        <input
          required
          type="text"
          name="number"
          id="gut-popup-phone-number"
          autocomplete="off"
          class="gut-popup-number-input"
        />
        <label class="gut-popup-label">Number</label>
      </div>

      <button type="button" class="gut-popup-submit">
        <span class="spinner" style="display: none"></span>
        <span class="submit-text">Submit</span>
      </button>

      <p class="gut-popup-success">
        Thank you for submitting, we will get back to you.
      </p>
      <p class="gut-popup-error">An error occurred, please try again.</p>
      <p class="gut-popup-invalid-phone">Invalid phone number</p>
    </section>

    <script>
      // ✅ Wait until the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        // ✅ Select elements only AFTER DOM is ready
        const submitButton = document.querySelector(".gut-popup-submit");
        const spinner = document.querySelector(".spinner");
        const buttonText = submitButton.querySelector(".submit-text");
        const nameInput = document.querySelector(".gut-popup-input");
        const numberInput = document.querySelector(".gut-popup-number-input");
        const successMessage = document.querySelector(".gut-popup-success");
        const errorMessage = document.querySelector(".gut-popup-error");
        const invalidPhoneMessage = document.querySelector(
          ".gut-popup-invalid-phone"
        );

        submitButton.addEventListener("click", function (event) {
          event.preventDefault();
          console.log("button clicked");
          // ✅ Reset messages
          successMessage.style.display = "none";
          errorMessage.style.display = "none";
          invalidPhoneMessage.style.display = "none";

          // ✅ Validate phone number
          const phoneRegex = /^[0-9]{10}$/;
          if (!phoneRegex.test(numberInput.value.trim())) {
            invalidPhoneMessage.style.display = "block";
            buttonText.textContent = "Try Again";
            spinner.style.display = "none";
            submitButton.disabled = false;
            return;
          }

          // ✅ Show loading state
          submitButton.disabled = true;
          //   submitButton.style.opacity = "1";
          spinner.style.display = "inline-block";
          buttonText.textContent = "Submitting...";

          // ✅ Prepare lead data
          const LeadData = {
            Last_Name: nameInput.value,
            Phone: numberInput.value,
            Form_Type: "Book an Appointment",
            Lead_Source: "Website Form",
            Page_URL: window.location.href,
          };

          const urlParams = new URLSearchParams(window.location.search);
          const gclid = urlParams.get("gclid") || "";
          const fbclid = urlParams.get("fbclid") || "";
          LeadData["clid"] = [gclid, fbclid].filter(Boolean).join("|");
          LeadData["UTM_Term"] = urlParams.get("utm_term") || "";
          LeadData["UTM_Content"] = urlParams.get("utm_content") || "";
          LeadData["UTM_Medium"] = urlParams.get("utm_medium") || "";
          LeadData["UTM_Campaign"] = urlParams.get("utm_campaign") || "";
          LeadData["UTM_Source"] = urlParams.get("utm_source") || "";
          LeadData["UTM_Platform"] = urlParams.get("utm_platform") || "";
          LeadData["UTM_Device"] = urlParams.get("utm_device") || "";

          // ✅ Send to Zoho
          async function sendToZoho() {
            try {
              const response = await fetch(
                "https://abl0a70bx9.execute-api.ap-south-1.amazonaws.com/Prod/create-lead",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(LeadData),
                }
              );

              if (response.ok) {
                const result = await response.json();
                console.log("Successfully sent to Zoho:", result);

                nameInput.value = "";
                numberInput.value = "";
                successMessage.style.display = "flex";

                spinner.style.display = "none";
                buttonText.textContent = "Submitted. Thank You!";

                sendToZapier(LeadData);
              } else {
                throw new Error("Zoho request failed");
              }
            } catch (error) {
              console.error("Error with Zoho request:", error);
              spinner.style.display = "none";
              buttonText.textContent = "Try Again";
              submitButton.disabled = false;

              sendToZapier(LeadData);
            }
          }

          // ✅ Send to Zapier
          function sendToZapier(leadData) {
            const zapierUrl =
              "https://hooks.zapier.com/hooks/catch/20814971/281t3lc/";
            const requestBody = new URLSearchParams(leadData).toString();

            const request = new XMLHttpRequest();
            request.open("POST", zapierUrl, true);
            request.setRequestHeader(
              "Content-type",
              "application/x-www-form-urlencoded"
            );

            request.onreadystatechange = function () {
              if (request.readyState === XMLHttpRequest.DONE) {
                if (request.status === 200) {
                  console.log("Successfully sent to Zapier");
                  successMessage.style.display = "flex";
                  spinner.style.display = "none";
                  buttonText.textContent = "Submitted. Thank You!";
                } else {
                  console.error("Zapier error:", request.status);
                  alert(
                    "Failed to send data to both Zoho and Zapier. Please try again."
                  );
                  spinner.style.display = "none";
                  buttonText.textContent = "Try Again";
                  submitButton.disabled = false;
                }
              }
            };

            request.send(requestBody);
          }

          // ✅ Send to SheetDB
          function sendtoGsheet() {
            fetch("https://sheetdb.io/api/v1/goink9rv5f9tp", {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                data: [
                  {
                    name: nameInput.value,
                    phone: numberInput.value,
                    time: new Date().toLocaleTimeString(),
                    date: new Date().toLocaleDateString(),
                    url: window.location.href,
                  },
                ],
              }),
            })
              .then((response) => response.json())
              .then((data) => console.log("Data sent to SheetDB:", data))
              .catch((error) => console.error("SheetDB error:", error));
          }

          // ✅ Trigger requests
          sendToZoho();
          sendtoGsheet();
        });
      });
    </script>
  </body>
</html>
